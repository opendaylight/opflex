
- This file contains the steps to manually test opflex agent changes with mininet.
- Please follow the basic steps to build and test using the instructions in https://wiki.opendaylight.org/view/OpFlex:Building_and_Running
- Any other feature testing extensions can be listed here.

VRF unenforced:
==============
The sample policy.json file generated by opflex_server will now contain a new routingDomain in unenforced mode.
There are 2 EPGs that are created without any  contracts between them.
The goal of this test is to allow communication between these EPGs without a need for contracts.

Step1:
- Add EP file under /usr/local/var/lib/opflex-agent-ovs/endpoints
- EP1 sample file:
{
    "policy-space-name": "test",
    "endpoint-group-name": "group1UnEnf",
    "interface-name": "s1-eth7",
    "ip": [
        "10.0.2.1"
    ],
    "mac": "00:00:00:00:00:07",
    "uuid": "83f18f0b-80f7-46e2-b06c-4d9487b0c777"
}
- EP2 sample file:
{
    "policy-space-name": "test",
    "endpoint-group-name": "group2UnEnf",
    "interface-name": "s1-eth8",
    "ip": [
        "10.0.3.1"
    ],
    "mac": "00:00:00:00:00:08",
    "uuid": "83f18f0b-80f7-46e2-b06c-4d9487b0c788"
}

Step2:
- Start opflex_server with the sample policy.json file: sudo ./opflex_server --policy=policy.json
- Create mininet with 8 hosts: sudo mn --topo=single,8 --controller=none --mac
- Start agent with appropriate config file: sudo ./opflex_agent -c agent.conf 2>&1 | tee agent.log

Step 3:
- Ensure the routing Domain objects are created appropriately.
- sudo gbp_inspect -fpq GbpRoutingDomain: "rdUnEnf" must be created with enforcementPreference = unenforced
- Ensure there is an openflow rule in policy table to bypass contracts for this VRF.

Step 4:
- The subnets for the 2 EPGs are from 10.0.2.x/24 and 10.0.3.x/24
- By default in mininet, the IPs for hosts are allocated from 10.0.0.x/24
- Change the IPs of h7 and h8 approapriately using below commands:
  From mininet:
    - h7 ifconfig h8-eth0 10.0.2.1/24
    - h8 ifconfig h8-eth0 10.0.3.1/24
    - "dump" might show old IPs still. But confirm the change using "<host> ifconfig".
    - Note: another way to change from the host directly is using:
        - sudo ip addr add dev s1-eth7 10.0.2.1/32
        - sudo ip addr add dev s1-eth8 10.0.3.1/32

Step 5:
- From mininet ping between h7 and h8
- Ensure the openflow rule in policy table is hit by checking the counters.

